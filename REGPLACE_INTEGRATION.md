# Интеграция reg.place

## Статус
✅ Парсер создан
⏳ Ожидает тестирования

## Что сделано

### 1. Создан парсер `competitions/regplace_parser.py`

Парсер использует aiohttp для асинхронных запросов к API reg.place.

**Основные функции:**
- `fetch_competitions()` - получение списка соревнований с фильтрацией
- `parse_event()` - парсинг одного события
- `normalize_sport_code()` - нормализация кодов спорта
- `matches_filters()` - применение фильтров по городу и спорту

**Поддерживаемые фильтры:**
- `city` - фильтр по городу
- `sport` - фильтр по виду спорта (run, bike, swim, triathlon, ski)
- `limit` - максимальное количество соревнований
- `period_months` - период в месяцах от текущей даты

### 2. Обновлен `competitions/competitions_fetcher.py`

Добавлена интеграция с reg.place:
- Импорт парсера reg.place
- Добавлен флаг `use_regplace` для выбора сервиса
- Добавлен код для получения соревнований из reg.place
- Обновлены константы `SERVICE_CODES` и `SERVICE_NAMES`

**Новый сервис в константах:**
```python
SERVICE_CODES = {
    "RussiaRunning": "RussiaRunning",
    "Timerman": "Timerman",
    "Лига Героев": "HeroLeague",
    "reg.place": "reg.place",  # <- НОВЫЙ
    "Все сервисы": "all",
}
```

### 3. Особенности парсера reg.place

**Попытка нескольких endpoint'ов:**
Парсер пробует различные возможные endpoint'ы для получения списка событий:
- `https://api.reg.place/v1/events`
- `https://api.reg.place/v1/event/list`
- `https://api.reg.place/v1/search`
- `https://reg.place/api/events`

**Обработка разных форматов ответа:**
- Прямой массив событий: `[event1, event2, ...]`
- Объект с массивом в ключе: `{events: [...], items: [...], data: [...], results: [...]}`

**Нормализация кодов спорта:**
- running, бег, марафон, забег → run
- cycling, велос, вело → bike
- swim, плав → swim
- triathlon, триатлон → triathlon
- ski, лыж → ski

**Формат выходных данных:**
```python
{
    'id': 'event-slug',
    'title': 'Название события',
    'url': 'https://reg.place/event/event-slug',
    'city': 'Москва',
    'date': '31.12.2025',
    'sport_code': 'run',
    'service': 'reg.place',
    'distances': [
        {'distance': 5.0, 'name': '5 км'},
        {'distance': 10.0, 'name': '10 км'}
    ],
    'start_time': datetime_object,
    'end_date': datetime_object
}
```

## Что нужно сделать дальше

### 1. Тестирование API
Необходимо определить:
- ✅ Какой именно endpoint возвращает список событий
- ⏳ Какая структура ответа от API
- ⏳ Какие поля доступны в событиях
- ⏳ Как передаются дистанции

### 2. Тестовые скрипты
Созданы следующие тестовые скрипты:
- `test_regplace_api.py` - первичное тестирование API endpoint'ов
- `find_regplace_api.py` - поиск рабочего endpoint с сохранением в файл
- `investigate_regplace.py` - исследование структуры API
- `test_regplace_sync.py` - синхронный тест с явным выводом
- `test_regplace_parser.py` - тест созданного парсера
- `test_regplace_final.py` - финальный тест с логированием
- `test_regplace_to_file.py` - тест с сохранением результатов в файл

### 3. Доработка после тестирования
После успешного тестирования может потребоваться:
- Корректировка парсинга полей (дата, город, дистанции)
- Уточнение нормализации кодов спорта
- Добавление обработки специфичных для reg.place полей
- Оптимизация timeout и обработки ошибок

### 4. Интеграция в UI
После подтверждения работы парсера:
- Добавить "reg.place" в меню выбора сервиса регистрации
- Проверить корректность отображения событий
- Протестировать фильтрацию и поиск
- Убедиться в корректной работе регистрации

## Примечания

### Документация API
Пользователь предоставил документацию API reg.place, которая показывает:
- Endpoint для одного события: `GET /v1/events/{slug}?compact=false&races=true`
- Endpoint для регистрации: `POST /v1/events/{slug}/participant`

Однако endpoint для получения **списка всех событий** в документации явно не указан,
поэтому парсер реализован с попыткой нескольких возможных вариантов.

### Логирование
Парсер использует подробное логирование для отладки:
- INFO - успешные операции и найденные endpoint'ы
- WARNING - неудачные попытки endpoint'ов
- ERROR - критические ошибки

Логи помогут определить какой endpoint работает и какая структура данных приходит.

### Совместимость
Парсер следует той же структуре, что и существующие парсеры:
- `heroleague_parser.py`
- `timerman_parser.py`
- `parser.py` (RussiaRunning)

Это обеспечивает единообразие кода и легкую интеграцию.
