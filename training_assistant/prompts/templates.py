"""
Prompt шаблоны для AI-ассистента тренера
"""

# ==================== SYSTEM PROMPTS ====================

SYSTEM_PROMPT_COACH = """Ты — профессиональный тренер по бегу, плаванию, велоспорту и триатлону с опытом работы более 10 лет.

Твои принципы:
- Даешь конкретные, практичные рекомендации
- Учитываешь текущий уровень спортсмена
- Объясняешь ПОЧЕМУ даешь те или иные рекомендации
- Пишешь кратко, по делу, без воды
- Используешь спортивные термины, но объясняешь их
- Всегда учитываешь безопасность и профилактику травм

Стиль общения: профессиональный, но дружелюбный. Мотивируешь, но не преувеличиваешь."""

SYSTEM_PROMPT_PSYCHOLOGIST = """Ты — спортивный психолог с опытом работы со спортсменами разного уровня.

Твои принципы:
- Слушаешь и понимаешь эмоции спортсмена
- Помогаешь рационализировать страхи и переживания
- Даешь конкретные техники и упражнения
- Мотивируешь фокусироваться на процессе, а не на результате
- Помогаешь переводить нервозность в продуктивную энергию

Стиль общения: эмпатичный, поддерживающий, спокойный."""


# ==================== ФУНКЦИЯ 1: ПЛАН ТРЕНИРОВОК ====================

PROMPT_TRAINING_PLAN = """Создай персональный тренировочный план для спортсмена.

ДАННЫЕ СПОРТСМЕНА:
- Вид спорта: {sport_type}
- Уровень подготовки: {fitness_level}
- Период плана: {plan_duration}
- Целевая дистанция: {target_distance} км
- Цель: {goal_description}
- Доступные дни для тренировок: {available_days}
- Последние тренировки (3 месяца): {recent_trainings}
- Личные рекорды: {personal_records}
- Соревнования: {competitions}
- Данные о здоровье: {health_data}

АНАЛИЗ УРОВНЯ ПОДГОТОВКИ:
Если уровень подготовки указан как "определи сам на основе данных ниже", проанализируй:
1. Объем тренировок (км в неделю)
2. Частоту тренировок
3. Темпы на тренировках
4. Результаты соревнований
5. Пульс покоя и восстановление
6. Прогрессию за 3 месяца

Определи уровень:
- Новичок: <20 км/неделю, темп >6:00 мин/км, нет соревнований
- Средний: 20-50 км/неделю, темп 5:00-6:00 мин/км, 1-3 соревнования
- Продвинутый: >50 км/неделю, темп <5:00 мин/км, регулярные соревнования

ТРЕБОВАНИЯ К ПЛАНУ:
1. План должен быть КОНКРЕТНЫМ: указывай тип тренировки, объем, интенсивность
2. Учитывай принцип периодизации: варьируй нагрузку
3. Включай разные типы тренировок: база, темповые, интервалы, восстановительные
4. Учитывай текущий уровень спортсмена
5. Если есть целевое соревнование — планируй подводку
6. **КРИТИЧЕСКИ ВАЖНО**: Используй ТОЛЬКО дни из списка "Доступные дни для тренировок". НЕ добавляй другие дни!

ФОРМАТ ОТВЕТА (JSON):
{{
    "plan": [
        {{
            "day": "Понедельник",
            "workout_type": "Кросс базовый",
            "volume": "10 км",
            "intensity": "низкая (пульс зона 2)",
            "target_pace": "5:30-6:00 мин/км",
            "description": "Краткое описание тренировки (2-3 предложения)",
            "purpose": "Аэробная база, восстановление"
        }},
        ...
    ],
    "explanation": "КРАТКОЕ объяснение плана (2-3 предложения, максимум 300 символов). Опиши ключевые принципы.",
    "weekly_volume": "40 км",
    "key_workouts": ["Интервалы в среду", "Длинная в воскресенье"],
    "recovery_tips": "Краткие советы по восстановлению (2-3 пункта, до 200 символов)"
}}

ВАЖНО:
- Поле "description" для каждой тренировки должно быть КРАТКИМ (2-3 предложения)
- Поле "explanation" должно быть КОРОТКИМ (не более 300 символов, 2-3 предложения)
- Поле "recovery_tips" должно быть КОРОТКИМ (2-3 ключевых совета)
- Будь конкретным и лаконичным

Верни ТОЛЬКО JSON, без дополнительного текста до или после."""


# ==================== ФУНКЦИЯ 2: КОРРЕКТИРОВКА ТРЕНИРОВКИ ====================

PROMPT_CORRECTION = """Проанализируй выполненную тренировку и дай рекомендации по корректировке плана.

ДАННЫЕ ТРЕНИРОВКИ:
- Тип: {training_type}
- Планируемый объем: {planned_volume}
- Фактический объем: {actual_volume}
- Темп: {pace}
- Средний пульс: {avg_pulse}
- Максимальный пульс: {max_pulse}
- Уровень усилий (1-10): {fatigue_level}

ОБРАТНАЯ СВЯЗЬ ОТ СПОРТСМЕНА:
- Оценка: {user_feedback}
- Комментарий: {user_comment}

КОНТЕКСТ:
- Последние 5 тренировок: {recent_trainings}
- Текущий план (если есть): {current_plan}
- Пульсовые зоны: {pulse_zones}

ТРЕБОВАНИЯ:
1. Проанализируй, что произошло (пульс выше нормы, темп не тот и т.д.)
2. Объясни ПОЧЕМУ могло так произойти (перегрузка, недовосстановление, неверный темп и т.д.)
3. Дай КОНКРЕТНЫЕ рекомендации для следующих тренировок
4. Скорректируй ближайшие тренировки если нужно

ФОРМАТ ОТВЕТА (JSON):
{{
    "analysis": "Детальный анализ тренировки",
    "reasons": ["Причина 1", "Причина 2"],
    "recommendations": [
        {{
            "type": "immediate",
            "text": "На следующей тренировке..."
        }},
        {{
            "type": "weekly",
            "text": "На этой неделе стоит..."
        }}
    ],
    "plan_adjustments": [
        {{
            "day": "Среда",
            "change": "Снизить объем с 12 до 10 км",
            "reason": "Для восстановления"
        }}
    ],
    "warning_signs": ["На что обратить внимание"]
}}

Будь честным и заботливым — здоровье важнее плана."""


# ==================== ФУНКЦИЯ 3: ПОДГОТОВКА К СОРЕВНОВАНИЮ ====================

PROMPT_RACE_PREPARATION = """Дай рекомендации по подготовке к соревнованию.

ДАННЫЕ СОРЕВНОВАНИЯ:
- Название: {competition_name}
- Дата: {competition_date}
- Дистанция: {distance} км
- Целевое время: {target_time}
- До старта: {days_before} дней

ДАННЫЕ СПОРТСМЕНА:
- Текущая форма (последние тренировки): {recent_trainings}
- Личный рекорд на дистанции: {personal_record}
- Средний объем в неделю: {weekly_volume}

ТРЕБОВАНИЯ (зависит от дней до старта):

ЗА 7 ДНЕЙ:
- Рекомендации по тренировкам (легкие, поддерживающие)
- Что делать: короткие интервалы для остроты формы
- Что НЕ делать: объемные тренировки, новые упражнения
- Питание и водный режим

ЗА 3 ДНЯ:
- Снижение нагрузки (tapering)
- Легкие пробежки
- Проверка экипировки
- Ментальная подготовка

ЗА 1 ДЕНЬ:
- Легкая разминочная пробежка (20-30 мин)
- Режим питания
- Сон и отдых
- Подготовка экипировки
- Визуализация забега

ФОРМАТ ОТВЕТА (JSON):
{{
    "training_recommendations": [
        {{
            "day": "Вторник",
            "workout": "Легкий кросс 6 км + 4x100м ускорения",
            "purpose": "Поддержание остроты формы"
        }}
    ],
    "do_list": ["Что ДЕЛАТЬ"],
    "dont_list": ["Что НЕ ДЕЛАТЬ"],
    "nutrition": "Рекомендации по питанию",
    "sleep": "Рекомендации по сну",
    "mental_prep": "Ментальная подготовка",
    "checklist": ["Чек-лист подготовки"]
}}

Будь конкретным и практичным. Это важный момент для спортсмена!"""


# ==================== ФУНКЦИЯ 4: ТАКТИКА ЗАБЕГА ====================

PROMPT_RACE_TACTICS = """Построй тактический план забега для спортсмена.

ДАННЫЕ ЗАБЕГА:
- Дистанция: {distance} км
- Целевое время: {target_time}
- Целевой средний темп: {target_pace} мин/км
- Тип трассы: {race_type}
- Количество кругов/этапов: {laps}

ДАННЫЕ СПОРТСМЕНА:
- Личный рекорд: {personal_record}
- Текущая форма: {recent_trainings}
- Пульсовые зоны: {pulse_zones}

ТРЕБОВАНИЯ:
1. Построй КОНКРЕТНЫЙ план по отрезкам/кругам
2. Учитывай правильное распределение сил
3. Дай советы по началу, середине и финишу
4. Укажи целевые сплиты
5. Дай план B (если что-то пойдет не так)

ФОРМАТ ОТВЕТА (JSON):
{{
    "pacing_strategy": "negative split / even pace / positive split",
    "strategy_explanation": "Почему выбрана эта стратегия",
    "splits": [
        {{
            "segment": "0-5 км",
            "target_pace": "5:15-5:20 мин/км",
            "target_pulse": "зона 3",
            "advice": "Не рвись, держи себя в руках"
        }},
        ...
    ],
    "start_strategy": "Как стартовать (позиция, темп первые 500м)",
    "middle_strategy": "Середина дистанции - на что смотреть",
    "finish_strategy": "Когда и как ускоряться на финише",
    "plan_b": "Если чувствуешь, что не идет - что делать",
    "mental_cues": ["Ментальные подсказки по ходу забега"],
    "nutrition_plan": "Если нужно питание/вода на дистанции"
}}

Будь конкретным. Спортсмен должен четко знать, что делать на каждом километре."""


# ==================== ФУНКЦИЯ 5: ПСИХОЛОГ ====================

PROMPT_PSYCHOLOGIST = """Спортсмен обращается к тебе с проблемой или переживанием.

КОНТЕКСТ:
- Предыдущие сообщения в диалоге: {conversation_history}
- Данные спортсмена: {athlete_context}

СООБЩЕНИЕ СПОРТСМЕНА:
{user_message}

ТВОЯ ЗАДАЧА:
1. Выслушать и показать понимание
2. Помочь рационализировать страхи/переживания
3. Дать конкретные техники или упражнения
4. Перевести фокус на то, что спортсмен может контролировать
5. Мотивировать и поддержать

ТИПОВЫЕ ПРОБЛЕМЫ:
- Страх перед стартом
- "Я не справлюсь"
- "Все тренировались больше меня"
- Потеря уверенности после плохой тренировки
- Сомнения в целевом времени
- Боязнь не оправдать ожидания

ФОРМАТ ОТВЕТА:
Свободный текст (НЕ JSON), но структурированный:

1. Эмпатия: "Понимаю, что ты чувствуешь..."
2. Рационализация: "Давай разберемся, что на самом деле происходит..."
3. Техника: "Попробуй такое упражнение/подход..."
4. Фокус на контролируемом: "Ты можешь контролировать..."
5. Поддержка: "Ты готов(а), потому что..."

Будь эмпатичным, но не льстивым. Помогай РЕАЛЬНО, не просто хвали."""


# ==================== ФУНКЦИЯ 6: ПРОГНОЗ РЕЗУЛЬТАТА ====================

PROMPT_RESULT_PREDICTION = """Спрогнозируй результат спортсмена на дистанции на основе его тренировок.

ПАРАМЕТРЫ ПРОГНОЗА:
- Целевая дистанция: {target_distance} км
- Период анализа: {analysis_period}

ДАННЫЕ ТРЕНИРОВОК:
{training_data}

ДОПОЛНИТЕЛЬНЫЕ ДАННЫЕ:
- Личные рекорды: {personal_records}
- Средненедельный объем: {weekly_volume}
- Пульсовые зоны и их соблюдение: {pulse_zone_adherence}
- Тренировки по типам: {training_types_distribution}

ТРЕБОВАНИЯ:
1. Проанализируй темпы на тренировках
2. Оцени общий объем и готовность
3. Учти прогрессию (становится ли лучше)
4. Дай 3 прогноза: реалистичный, оптимистичный, осторожный
5. Объясни ПОЧЕМУ такой прогноз
6. Укажи факторы, которые влияют на результат

ФОРМАТ ОТВЕТА (JSON):
{{
    "predictions": {{
        "realistic": "1:45:00",
        "optimistic": "1:42:30",
        "conservative": "1:48:00"
    }},
    "confidence_level": 75,
    "explanation": "Детальное объяснение прогноза",
    "key_factors": [
        {{
            "factor": "Средний темп на длинных",
            "value": "5:10 мин/км",
            "impact": "positive"
        }},
        ...
    ],
    "strengths": ["Сильные стороны подготовки"],
    "weaknesses": ["Что можно улучшить"],
    "recommendations": "Что сделать, чтобы улучшить прогноз",
    "race_pace_recommendation": "5:00-5:05 мин/км"
}}

Будь честным и объективным. Прогноз должен быть реалистичным, основанным на данных."""


# ==================== HELPER FUNCTIONS ====================

def format_trainings_for_prompt(trainings: list) -> str:
    """Форматирует тренировки для промпта"""
    if not trainings:
        return "Нет данных о тренировках"

    formatted = []
    for t in trainings:
        parts = [
            f"- {t.get('date')}: {t.get('type')}",
            f"{t.get('distance', 'N/A')} км" if t.get('distance') else "",
            f"темп {t.get('avg_pace', 'N/A')}" if t.get('avg_pace') else "",
            f"пульс {t.get('avg_pulse', 'N/A')}" if t.get('avg_pulse') else "",
            f"усилия {t.get('fatigue_level', 'N/A')}/10" if t.get('fatigue_level') else ""
        ]
        formatted.append(" ".join([p for p in parts if p]))

    return "\n".join(formatted)


def format_personal_records(records: dict) -> str:
    """Форматирует личные рекорды"""
    if not records:
        return "Нет данных о личных рекордах"

    formatted = []
    for distance, time in records.items():
        formatted.append(f"- {distance} км: {time}")

    return "\n".join(formatted)
