# ========== –î–ï–ô–°–¢–í–ò–Ø –¢–†–ï–ù–ï–†–ê –° –°–û–†–ï–í–ù–û–í–ê–ù–ò–Ø–ú–ò –£–ß–ï–ù–ò–ö–ê ==========

@router.callback_query(F.data.startswith("coach:edit_student_target:"))
async def edit_student_target_time(callback: CallbackQuery, state: FSMContext):
    """–¢—Ä–µ–Ω–µ—Ä –∏–∑–º–µ–Ω—è–µ—Ç —Ü–µ–ª–µ–≤–æ–µ –≤—Ä–µ–º—è —É—á–µ–Ω–∏–∫–∞"""
    parts = callback.data.split(":")
    student_id = int(parts[2])
    competition_id = int(parts[3])
    distance = float(parts[4])
    coach_id = callback.from_user.id

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø
    if not await can_coach_access_student(coach_id, student_id):
        await callback.answer("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞", show_alert=True)
        return

    display_name = await get_student_display_name(coach_id, student_id)

    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–∏
    from competitions.competitions_queries import get_competition
    competition = await get_competition(competition_id)

    if not competition:
        await callback.answer("‚ùå –°–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ", show_alert=True)
        return

    # –ü–æ–ª—É—á–∞–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é —É—á–µ–Ω–∏–∫–∞
    from competitions.competitions_queries import get_user_competitions
    user_comps = await get_user_competitions(student_id)

    # –ù–∞—Ö–æ–¥–∏–º –Ω—É–∂–Ω—É—é —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é (—Å —É—á–µ—Ç–æ–º distance=0)
    registration = None
    for comp in user_comps:
        comp_distance = comp.get('distance')
        if comp['id'] == competition_id:
            if (comp_distance == distance) or \
               (comp_distance in (None, 0) and distance in (None, 0)):
                registration = comp
                break

    if not registration:
        registrations_for_comp = [c for c in user_comps if c['id'] == competition_id]
        if len(registrations_for_comp) == 1:
            registration = registrations_for_comp[0]
        else:
            await callback.answer("‚ùå –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞", show_alert=True)
            return

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏
    await state.update_data(
        edit_student_target_comp_id=competition_id,
        edit_student_target_distance=distance,
        edit_student_target_student_id=student_id
    )

    from competitions.competitions_utils import format_competition_distance as format_dist_with_units
    from database.queries import get_user_settings
    from utils.unit_converter import safe_convert_distance_name

    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∏—Å—Ç–∞–Ω—Ü–∏—é
    distance_name = registration.get('distance_name') if registration else None
    if distance_name and isinstance(distance_name, str):
        distance_name = distance_name.strip()
        if distance_name.lower() in ('none', 'null', '0', '0.0', ''):
            distance_name = None

    if distance_name and distance_name.strip():
        settings = await get_user_settings(coach_id)
        distance_unit = settings.get('distance_unit', '–∫–º') if settings else '–∫–º'

        import re
        if re.match(r'^\d+(\.\d+)?$', distance_name):
            dist_str = f"{distance_name} {distance_unit}"
        else:
            dist_str = safe_convert_distance_name(distance_name, distance_unit)
    else:
        dist_str = await format_dist_with_units(distance, coach_id)

    text = (
        f"üë§ –£—á–µ–Ω–∏–∫: <b>{display_name}</b>\n\n"
        f"üèÉ <b>{competition['name']}</b>\n"
        f"üìè –î–∏—Å—Ç–∞–Ω—Ü–∏—è: {dist_str}\n\n"
        f"–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ —Ü–µ–ª–µ–≤–æ–µ –≤—Ä–µ–º—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ß–ß:–ú–ú:–°–° –∏–ª–∏ –ú–ú:–°–°:\n\n"
        f"<i>–ù–∞–ø—Ä–∏–º–µ—Ä:\n"
        f"‚Ä¢ 03:30:00 (3 —á–∞—Å–∞ 30 –º–∏–Ω—É—Ç)\n"
        f"‚Ä¢ 45:00 (45 –º–∏–Ω—É—Ç)\n"
        f"‚Ä¢ 1:30:15 (1 —á–∞—Å 30 –º–∏–Ω—É—Ç 15 —Å–µ–∫—É–Ω–¥)</i>"
    )

    await callback.message.answer(
        text,
        parse_mode="HTML",
        reply_markup=get_cancel_keyboard()
    )
    await state.set_state(CoachStates.waiting_for_student_target_time)
    await callback.answer()


@router.message(CoachStates.waiting_for_student_target_time)
async def process_student_target_time_edit(message: Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –Ω–æ–≤–æ–µ —Ü–µ–ª–µ–≤–æ–µ –≤—Ä–µ–º—è —É—á–µ–Ω–∏–∫–∞"""
    from utils.time_formatter import validate_time_format

    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await message.answer("‚ùå –ò–∑–º–µ–Ω–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ", reply_markup=ReplyKeyboardRemove())
        await state.clear()
        return

    # –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏
    time_str = validate_time_format(message.text)
    if not time_str:
        await message.answer(
            "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ß–ß:–ú–ú:–°–° –∏–ª–∏ –ú–ú:–°–°\n"
            "–ù–∞–ø—Ä–∏–º–µ—Ä: 03:30:00 –∏–ª–∏ 45:00"
        )
        return

    data = await state.get_data()
    competition_id = data.get('edit_student_target_comp_id')
    distance = data.get('edit_student_target_distance')
    student_id = data.get('edit_student_target_student_id')
    coach_id = message.from_user.id

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø
    if not await can_coach_access_student(coach_id, student_id):
        await message.answer("‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞", reply_markup=ReplyKeyboardRemove())
        await state.clear()
        return

    # –û–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–ª–µ–≤–æ–µ –≤—Ä–µ–º—è
    from competitions.competitions_queries import update_target_time
    success = await update_target_time(student_id, competition_id, distance, time_str)

    if success:
        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        from competitions.competitions_queries import get_competition
        comp = await get_competition(competition_id)
        display_name = await get_student_display_name(coach_id, student_id)

        # –£–≤–µ–¥–æ–º–ª—è–µ–º —É—á–µ–Ω–∏–∫–∞
        try:
            from bot.keyboards import get_main_menu_keyboard
            from coach.coach_queries import is_user_coach
            student_is_coach = await is_user_coach(student_id)

            await message.bot.send_message(
                student_id,
                f"üë®‚Äçüè´ <b>–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–µ–ª–µ–≤–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏</b>\n\n"
                f"–í–∞—à —Ç—Ä–µ–Ω–µ—Ä –∏–∑–º–µ–Ω–∏–ª —Ü–µ–ª–µ–≤–æ–µ –≤—Ä–µ–º—è –¥–ª—è —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏—è:\n\n"
                f"üèÜ <b>{comp['name']}</b>\n"
                f"üéØ –ù–æ–≤–æ–µ —Ü–µ–ª–µ–≤–æ–µ –≤—Ä–µ–º—è: <b>{time_str}</b>",
                parse_mode="HTML",
                reply_markup=get_main_menu_keyboard(is_coach=student_is_coach)
            )
        except Exception as e:
            logger.error(f"Error sending notification to student: {e}")

        await message.answer(
            f"‚úÖ –¶–µ–ª–µ–≤–æ–µ –≤—Ä–µ–º—è –¥–ª—è —É—á–µ–Ω–∏–∫–∞ <b>{display_name}</b> –æ–±–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ {time_str}",
            parse_mode="HTML",
            reply_markup=ReplyKeyboardRemove()
        )
    else:
        await message.answer(
            "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ü–µ–ª–µ–≤–æ–µ –≤—Ä–µ–º—è",
            reply_markup=ReplyKeyboardRemove()
        )

    await state.clear()


@router.callback_query(F.data.startswith("coach:cancel_student_reg:"))
async def cancel_student_registration(callback: CallbackQuery):
    """–¢—Ä–µ–Ω–µ—Ä –æ—Ç–º–µ–Ω—è–µ—Ç —É—á–∞—Å—Ç–∏–µ —É—á–µ–Ω–∏–∫–∞ –≤ —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–∏ - –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ"""
    parts = callback.data.split(":")
    student_id = int(parts[2])
    competition_id = int(parts[3])
    distance = float(parts[4])
    coach_id = callback.from_user.id

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø
    if not await can_coach_access_student(coach_id, student_id):
        await callback.answer("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞", show_alert=True)
        return

    display_name = await get_student_display_name(coach_id, student_id)

    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–∏
    from competitions.competitions_queries import get_competition
    competition = await get_competition(competition_id)

    if not competition:
        await callback.answer("‚ùå –°–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ", show_alert=True)
        return

    # –ü–æ–ª—É—á–∞–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏
    from competitions.competitions_queries import get_user_competitions
    user_comps = await get_user_competitions(student_id)

    registration = None
    for comp in user_comps:
        comp_distance = comp.get('distance')
        if comp['id'] == competition_id:
            if (comp_distance == distance) or \
               (comp_distance in (None, 0) and distance in (None, 0)):
                registration = comp
                break

    if not registration:
        registrations_for_comp = [c for c in user_comps if c['id'] == competition_id]
        if len(registrations_for_comp) == 1:
            registration = registrations_for_comp[0]
        else:
            await callback.answer("‚ùå –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞", show_alert=True)
            return

    from competitions.competitions_utils import format_competition_distance as format_dist_with_units
    from database.queries import get_user_settings
    from utils.unit_converter import safe_convert_distance_name

    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∏—Å—Ç–∞–Ω—Ü–∏—é
    distance_name = registration.get('distance_name') if registration else None
    if distance_name and isinstance(distance_name, str):
        distance_name = distance_name.strip()
        if distance_name.lower() in ('none', 'null', '0', '0.0', ''):
            distance_name = None

    if distance_name and distance_name.strip():
        settings = await get_user_settings(coach_id)
        distance_unit = settings.get('distance_unit', '–∫–º') if settings else '–∫–º'

        import re
        if re.match(r'^\d+(\.\d+)?$', distance_name):
            dist_str = f"{distance_name} {distance_unit}"
        else:
            dist_str = safe_convert_distance_name(distance_name, distance_unit)
    else:
        dist_str = await format_dist_with_units(distance, coach_id)

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    from aiogram.utils.keyboard import InlineKeyboardBuilder
    builder = InlineKeyboardBuilder()
    builder.row(
        InlineKeyboardButton(
            text="‚úÖ –î–∞, –æ—Ç–º–µ–Ω–∏—Ç—å",
            callback_data=f"coach:cancel_student_reg_confirm:{student_id}:{competition_id}:{distance}"
        )
    )
    builder.row(
        InlineKeyboardButton(
            text="‚ùå –ù–µ—Ç, –≤–µ—Ä–Ω—É—Ç—å—Å—è",
            callback_data=f"coach:view_student_comp:{student_id}:{competition_id}:{distance}"
        )
    )

    text = (
        f"‚ö†Ô∏è <b>–ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï</b>\n\n"
        f"–û—Ç–º–µ–Ω–∏—Ç—å —É—á–∞—Å—Ç–∏–µ —É—á–µ–Ω–∏–∫–∞ <b>{display_name}</b> –≤ —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–∏?\n\n"
        f"üèÜ <b>{competition['name']}</b>\n"
        f"üìè –î–∏—Å—Ç–∞–Ω—Ü–∏—è: {dist_str}\n\n"
        f"<i>–£—á–µ–Ω–∏–∫ –ø–æ–ª—É—á–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—Ç–º–µ–Ω–µ.</i>"
    )

    await callback.answer()
    await callback.message.edit_text(
        text,
        reply_markup=builder.as_markup(),
        parse_mode="HTML"
    )


@router.callback_query(F.data.startswith("coach:cancel_student_reg_confirm:"))
async def confirm_cancel_student_registration(callback: CallbackQuery):
    """–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ—Ç–º–µ–Ω—É —É—á–∞—Å—Ç–∏—è —É—á–µ–Ω–∏–∫–∞"""
    parts = callback.data.split(":")
    student_id = int(parts[2])
    competition_id = int(parts[3])
    distance = float(parts[4])
    coach_id = callback.from_user.id

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø
    if not await can_coach_access_student(coach_id, student_id):
        await callback.answer("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞", show_alert=True)
        return

    display_name = await get_student_display_name(coach_id, student_id)

    await callback.answer()

    # –û—Ç–º–µ–Ω—è–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
    from competitions.competitions_queries import unregister_from_competition_with_distance, get_competition
    success = await unregister_from_competition_with_distance(student_id, competition_id, distance)

    if success:
        comp = await get_competition(competition_id)

        # –£–≤–µ–¥–æ–º–ª—è–µ–º —É—á–µ–Ω–∏–∫–∞
        try:
            from bot.keyboards import get_main_menu_keyboard
            from coach.coach_queries import is_user_coach
            student_is_coach = await is_user_coach(student_id)

            await callback.bot.send_message(
                student_id,
                f"üë®‚Äçüè´ <b>–û—Ç–º–µ–Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</b>\n\n"
                f"–í–∞—à —Ç—Ä–µ–Ω–µ—Ä –æ—Ç–º–µ–Ω–∏–ª –≤–∞—à—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –Ω–∞ —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–µ:\n\n"
                f"üèÜ <b>{comp['name']}</b>\n\n"
                f"<i>–í—ã –º–æ–∂–µ—Ç–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è —Å–Ω–æ–≤–∞ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ.</i>",
                parse_mode="HTML",
                reply_markup=get_main_menu_keyboard(is_coach=student_is_coach)
            )
        except Exception as e:
            logger.error(f"Error sending notification to student: {e}")

        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ —Å–ø–∏—Å–∫—É —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–π —É—á–µ–Ω–∏–∫–∞
        await callback.message.edit_text(
            f"‚úÖ –£—á–∞—Å—Ç–∏–µ —É—á–µ–Ω–∏–∫–∞ <b>{display_name}</b> –æ—Ç–º–µ–Ω–µ–Ω–æ",
            parse_mode="HTML"
        )

        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–π
        from types import SimpleNamespace
        fake_callback = SimpleNamespace(
            data=f"coach:student_competitions:{student_id}",
            from_user=callback.from_user,
            message=callback.message,
            answer=callback.answer,
            bot=callback.bot
        )
        from aiogram.fsm.context import FSMContext as FSMContextType
        fake_state = FSMContextType(
            storage=callback.bot.get("state").storage if hasattr(callback.bot, "get") else None,
            key=callback.message.chat.id
        )
        await show_student_competitions(fake_callback, fake_state)
    else:
        await callback.message.edit_text("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–º–µ–Ω–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é")


@router.callback_query(F.data.startswith("coach:view_student_result:"))
async def view_student_result(callback: CallbackQuery):
    """–ü—Ä–æ—Å–º–æ—Ç—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏—è —É—á–µ–Ω–∏–∫–∞"""
    parts = callback.data.split(":")
    student_id = int(parts[2])
    competition_id = int(parts[3])
    distance = float(parts[4])
    coach_id = callback.from_user.id

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø
    if not await can_coach_access_student(coach_id, student_id):
        await callback.answer("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞", show_alert=True)
        return

    display_name = await get_student_display_name(coach_id, student_id)

    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–∏ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ
    from competitions.competitions_queries import get_user_competitions, get_competition
    user_comps = await get_user_competitions(student_id, competition_id=competition_id)

    if not user_comps:
        await callback.answer("‚ùå –†–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω", show_alert=True)
        return

    comp_result = user_comps[0]
    competition = await get_competition(competition_id)

    if not competition:
        await callback.answer("‚ùå –°–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ", show_alert=True)
        return

    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    from competitions.competitions_utils import format_competition_distance as format_dist_with_units, format_competition_date
    from utils.date_formatter import get_user_date_format
    from database.queries import get_user_settings
    from utils.unit_converter import safe_convert_distance_name
    from utils.time_formatter import normalize_time, calculate_pace_with_unit
    from competitions.competitions_keyboards import format_qualification

    coach_date_format = await get_user_date_format(coach_id)

    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∏—Å—Ç–∞–Ω—Ü–∏—é
    distance_name = comp_result.get('distance_name')

    if distance_name:
        settings = await get_user_settings(coach_id)
        distance_unit = settings.get('distance_unit', '–∫–º') if settings else '–∫–º'
        dist_str = safe_convert_distance_name(distance_name, distance_unit)
    else:
        dist_str = await format_dist_with_units(comp_result['distance'], coach_id)

    date_str = await format_competition_date(comp_result['date'], coach_id)

    # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ç–µ–º–ø
    pace = await calculate_pace_with_unit(comp_result['finish_time'], comp_result['distance'], coach_id)

    text = (
        f"üë§ –£—á–µ–Ω–∏–∫: <b>{display_name}</b>\n\n"
        f"üèÜ <b>{competition['name']}</b>\n\n"
        f"üìÖ –î–∞—Ç–∞: {date_str}\n"
        f"üìè –î–∏—Å—Ç–∞–Ω—Ü–∏—è: {dist_str}\n"
        f"‚è±Ô∏è –í—Ä–µ–º—è: {normalize_time(comp_result['finish_time'])}\n"
    )

    if pace:
        text += f"‚ö° –¢–µ–º–ø: {pace}\n"

    if comp_result.get('place_overall'):
        text += f"üèÜ –ú–µ—Å—Ç–æ –æ–±—â–µ–µ: {comp_result['place_overall']}\n"
    if comp_result.get('place_age_category'):
        text += f"üèÖ –ú–µ—Å—Ç–æ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: {comp_result['place_age_category']}\n"
    if comp_result.get('qualification'):
        text += f"üéñÔ∏è –†–∞–∑—Ä—è–¥: {format_qualification(comp_result['qualification'])}\n"
    if comp_result.get('heart_rate'):
        text += f"‚ù§Ô∏è –°—Ä–µ–¥–Ω–∏–π –ø—É–ª—å—Å: {comp_result['heart_rate']} —É–¥/–º–∏–Ω\n"

    # –ö–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞
    from aiogram.utils.keyboard import InlineKeyboardBuilder
    builder = InlineKeyboardBuilder()
    builder.row(
        InlineKeyboardButton(
            text="‚óÄÔ∏è –ù–∞–∑–∞–¥ –∫ —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏—é",
            callback_data=f"coach:view_student_comp:{student_id}:{competition_id}:{distance}"
        )
    )

    await callback.message.edit_text(
        text,
        reply_markup=builder.as_markup(),
        parse_mode="HTML"
    )
    await callback.answer()


# –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Ç—Ä–µ–±—É—é—Ç FSM —Å–æ—Å—Ç–æ—è–Ω–∏—è
# –∏ –±–æ–ª—å—à–æ–π –ª–æ–≥–∏–∫–∏, –∫–æ—Ç–æ—Ä–∞—è –∞–Ω–∞–ª–æ–≥–∏—á–Ω–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º –¥–ª—è —É—á–µ–Ω–∏–∫–∞.
# –û–Ω–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º CoachStates.
