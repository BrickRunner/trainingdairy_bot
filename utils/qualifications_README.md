# Модуль определения спортивных разрядов

Модуль `utils/qualifications.py` предназначен для автоматического определения спортивных разрядов на основе результатов соревнований.

## Источники нормативов

Все нормативы взяты из официальных документов ЕВСК (Единая всероссийская спортивная классификация) 2022-2025 гг.:

### Легкая атлетика (бег)
- **Источник**: [beguza.ru/evsk](https://beguza.ru/evsk/)
- **Дистанции**: 5 км, 10 км, 21.1 км (полумарафон), 42.2 км (марафон)
- **Разряды**: МСМК, МС, КМС, I, II, III
- **Действуют с**: 26 ноября 2024 года

### Плавание (вольный стиль)
- **Источник**: [marathonec.ru/razryadi-normativi-po-plavaniu](https://marathonec.ru/razryadi-normativi-po-plavaniu/)
- **Дистанции**: 50м, 100м, 200м, 400м, 800м, 1500м
- **Бассейны**: 25м и 50м (разные нормативы)
- **Разряды**: МСМК, МС, КМС, I, II, III
- **Действуют с**: 25 ноября 2024 года

### Велоспорт
- В велоспорте разряды присваиваются по занятым местам на соревнованиях определенного уровня, а не по времени
- Автоматический расчет разряда по времени не применим

## Использование

### Основные функции

```python
from utils.qualifications import get_qualification, time_to_seconds

# Определение разряда по бегу
distance_km = 21.1  # полумарафон
time_str = "1:08:30"
time_seconds = time_to_seconds(time_str)
qualification = get_qualification("бег", distance_km, time_seconds, "male")
# Результат: "КМС"

# Определение разряда по плаванию
distance_km = 0.1  # 100 метров
time_str = "54.50"
time_seconds = time_to_seconds(time_str)
qualification = get_qualification("плавание", distance_km, time_seconds, "male", pool_length=50)
# Результат: "КМС"
```

### Функция `get_qualification()`

```python
def get_qualification(
    sport_type: str,      # 'running', 'swimming', 'бег', 'плавание'
    distance_km: float,   # дистанция в километрах
    time_seconds: float,  # время в секундах
    gender: str,          # 'male', 'female', 'м', 'ж'
    **kwargs              # дополнительные параметры (pool_length для плавания)
) -> Optional[str]:
    """
    Возвращает разряд ('МСМК', 'МС', 'КМС', 'I', 'II', 'III') или None
    """
```

### Функция `time_to_seconds()`

```python
def time_to_seconds(time_str: str) -> float:
    """
    Преобразует время в секунды

    Поддерживаемые форматы:
    - "23.95" -> 23.95 сек
    - "1:05.34" -> 65.34 сек
    - "15:30" -> 930.0 сек
    - "1:15:30" -> 4530.0 сек
    - "2:12:00" -> 7920.0 сек
    """
```

## Интеграция с ботом

Расчет разрядов автоматически выполняется при добавлении результатов соревнований:

1. **При добавлении результата** (`competitions/competitions_queries.py::add_competition_result()`):
   - Получается тип спорта из таблицы `competitions`
   - Получается пол пользователя из таблицы `user_settings`
   - Рассчитывается разряд на основе дистанции и времени
   - Разряд сохраняется в поле `qualification` таблицы `competition_participants`

2. **При обновлении личных рекордов** (`competitions/competitions_queries.py::update_personal_record()`):
   - Разряд передается как параметр из `add_competition_result()`
   - Сохраняется в поле `qualification` таблицы `personal_records`

3. **При отображении результатов** (`competitions/competitions_handlers.py`):
   - В разделе "Результаты соревнований" (строка 1010-1012)
   - В разделе "Личные рекорды" (строка 1087-1089)

## Миграция существующих данных

Для обновления разрядов в существующих результатах используйте скрипт:

```bash
python migrations/update_qualifications.py
```

Скрипт:
- Пройдет по всем завершенным соревнованиям
- Рассчитает разряды на основе сохраненных результатов
- Обновит поля `qualification` в таблицах `competition_participants` и `personal_records`

## Расширение

### Добавление новых дистанций

Отредактируйте словари `RUNNING_STANDARDS` или `SWIMMING_STANDARDS_*` в файле `utils/qualifications.py`:

```python
RUNNING_STANDARDS = {
    'men': {
        15.0: {  # новая дистанция 15 км
            'МСМК': 45 * 60 + 0.0,
            'МС': 48 * 60 + 0.0,
            # ...
        },
    },
}
```

### Добавление новых видов спорта

1. Создайте словарь с нормативами (аналогично `RUNNING_STANDARDS`)
2. Добавьте функцию `get_qualification_<sport>()`
3. Добавьте проверку в функцию `get_qualification()`

## Тестирование

Для проверки работы модуля запустите тесты:

```bash
python test_qualifications.py
```

Тесты проверяют:
- Конвертацию времени в секунды
- Определение разрядов по бегу
- Определение разрядов по плаванию
- Форматирование разрядов для отображения
